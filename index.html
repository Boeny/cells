<html>
<body>
<script>
function getCellDefaultState() {
  return {
    type: 'default',
    growingSpeed: 0.2,
    width: 20,
    height: 20,
    maxWidthBeforeDivide: 40,
    reducingSpeed: -0.5,
    startConc: 1,
    endConc: 0,
    concLength: 100,
    get concPerPix() {
      return 1 / this.concLength;
    }
  };
}

function getDefaultState() {
  return {
    maxCells: 10,
    cells: [getCellDefaultState()]
  };
}

const state = getDefaultState();

// --- cell actions

function modWidth(props) {
  props.endConc = props.startConc - props.width * props.concPerPix;
  if (props.endConc < 0) {
    props.endConc = 0;
  } else {
    props.width += props[props.type + 'Speed'];
  }
}

function divide(props) {
  if (state.cells.length < state.maxCells) {
    const newCell = getCellDefaultState();
    props.endConc /= 2;
    newCell.startConc = props.endConc;
    state.cells.push(newCell);
    props.width /= 2;
  }
}

function die(props) {
  const index = state.cells.indexOf(props);
  state.cells.splice(index, 1);
}

function cellAction(props) {
  let nextType;
  switch (props.type) {
    case 'default':
      nextType = 'growing';
      break;
    case 'growing':
      modWidth(props);
      nextType = props.width >= props.maxWidthBeforeDivide ? 'division': props.type;
      break;
    case 'division':
      divide(props);
      nextType = 'growing';
      break;
    case 'reducing':
      modWidth(props);
      nextType = props.width <= 0 ? 'die' : props.type;
      break;
  }
  if (nextType === 'die') {
    die(props);
  } else {
    props.type = nextType;
  }
}

// --- utils

function style(o) {
  return Object.keys(o)
  .map(key => [key, o[key]].join(':'))
  .join(';');
}

function rgb(conc) {
  const color = Math.round((1 - conc) * 255);
  return 'rgb('+[color, color, color].join(',')+')';
}

function div(_style, content='') {
  return '<div style="'+style(_style)+'">'+content+'</div>';
}

// --- views

/**
 * props: {
    width: number;
    height: number;
    color: string;
    top: number;
    left: number;
  }
 */
function organella(props) {
  const { color, ...rest } = props;
  return div({
    position: 'absolute',
    background: color,
    ...rest
  });
}

function dividerOrgan() {
  return organella({
    color: 'red',
    width: 10,
    height: 10,
    top: 5,
    left: 5
  });
}

/**
 * props: {
    width: string;
    height: string;
    startConc: number;
    endConc: number;
  }
 */
function cell(props) {
  return div({
    position: 'relative',
    border: '1px solid #444',
    background: 'linear-gradient(to right,'+rgb(props.startConc)+','+rgb(props.endConc)+')',
    ...props
  }, props.startConc < 0.2 ? dividerOrgan() : '');
}

function activeCell(props) {
  cellAction(props);
  const { width, height, startConc, endConc } = props;
  return cell({ width, height, startConc, endConc });
}

function cells(props) {
  return props.map(activeCell).join('');
}

function render(props) {
  return cells(props.cells);
}

function main() {
  requestAnimationFrame(main);
  document.body.innerHTML = render(state);
}
main();
</script>
</body>
</html>
