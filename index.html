<html>
<body>
<script>
function getOrganellaDefaultState() {
  return {
    substance: ''
  };
}

function getCellDefaultState(parent = null) {
  return {
    type: 'default',
    parent,
    child: null,
    growingSpeed: 15,
    width: 15,
    height: 15,
    reducingSpeed: 0,
    organellas: [{substance: 'energy'}, {substance: 'divider'}],
    direction: {substance: 'direction', color: 'red', width: 5, height: 5, float: 'left'},
    tail: {substance: 'tail', color: 'green', width: 5, height: 5, float: 'right'},
    
    initConc: 1/50,

    get energy() {
      return this.substances['energy'] || 0;
    },
    set energy(conc) {
      this.substances['energy'] = conc;
    },

    get startConc() {
      return this.substances['direction'] || 0;
    },
    set startConc(conc) {
      this.substances['direction'] = conc;
    },
    get endConc() {
      return this.startConc / this.width;
    },
    get midConc() {
      return this.endConc * 2;
    },

    get startDividerConc() {
      this.substances['divider'] || 0;
    },
    set startDividerConc(conc) {
      this.substances['divider'] = conc;
    },
    get endDividerConc() {
      return this.startDividerConc / this.width;
    },

    get startTailConc() {
      this.substances['tail'] || 0;
    },
    set startTailConc(conc) {
      this.substances['tail'] = conc;
    },
    get endTailConc() {
      return this.startTailConc / this.width;
    },

    get index() {
      return state.cells.indexOf(this);
    },
    substances: {}
  };
}

function getDefaultState() {
  return {
    cells: [getCellDefaultState()],
    maxCount: 10
  };
}

const state = getDefaultState();


// ---------
// --- cell actions

function modWidth(props) {
  if (props.energy > 0) {
    const speed = Math.min(props.energy, props.growingSpeed);
    props.width += speed;
    props.energy -= speed;
  } else {
    return;
  }
  if (props.child) {
    props.child.startConc = props.endConc;
  }
  if (props.parent && props.startTailConc) {
    props.parent.startTailConc = props.endTailConc;
  }
}

function divide(props) {
  if (state.cells.length >= state.maxCount) {
    return 'reducing';
  }
  const midConc = props.midConc;
  props.width /= 2;
  
  const newCell = getCellDefaultState(props);
  newCell.startConc = midConc;
  props.child = newCell;

  state.cells.splice(props.index + 1, 0, newCell);
  return 'growing';
}

function die(props) {
  state.cells.splice(props.index, 1);
}

function cellAction(props) {
  if (props.startConc < props.initConc) {
    props.organellas.push(props.direction);
  }

  if (props.endDividerConc < 1/30 && !props.startTailConc) {
    props.type = divide(props);
  }

  if (props.startConc > props.initConc && props.endConc < 1/60 && !props.startTailConc) {
    props.organellas.push(props.tail);
    props.startTailConc = 0.001;
  }

  modWidth(props);

  if (props.width <= 0) {
    die(props);
    return;
  }
}


// ---------
// --- organella actions

const produce = containerProps => substance => {
  let conc = containerProps.substances[substance] || 0;
  if (conc < 0) {
    containerProps.substances[substance] = 0;
    return;
  }
  const speed = conc < 0.5 ? 0.1 : (1 - conc)/5;
  conc += speed;
  containerProps.substances[substance] = conc;
}


// ---------
// --- utils

function style(o) {
  return Object.keys(o)
  .map(key => [key, o[key]].join(':'))
  .join(';');
}

function rgb(conc) {
  const color = conc >= 1 ? 0 : Math.round((1 - conc) * 255);
  return 'rgb('+[color, color, color].join(',')+')';
}

function div(_style, content='') {
  return '<div style="'+style(_style)+'">'+content+'</div>';
}

function divs(arr, forEachDiv) {
  return arr.map(forEachDiv).join('');
}


// ---------
// --- views

/**
 * props: {
    width: number;
    height: number;
    color: string;
    top: number;
    left: number;
  }
 */
function organella(props) {
  const { color, ...rest } = props;
  return div({
    background: color,
    ...rest
  });
}

function activeOrganella(props) {
  const { produce, substance, ...rest } = props;
  produce(substance);
  return props.color ? organella(rest) : '';
}

/**
 * props: {
    width: string;
    height: string;
    leftColor: string;
    rightColor: string;
    content: string;
  }
 */
function cell(props) {
  const { width, height } = props;
  return div({
    display: 'inline-block',
    position: 'relative',
    border: '1px solid #444',
    padding: 2,
    background: 'linear-gradient(to right,'+props.leftColor+','+props.rightColor+')',
    width, height
  }, props.content || '');
}

function activeCell(props) {
  cellAction(props);
  const { width, height } = props;
  const produceSubstance = produce(props);
  return cell({
    width, height,
    leftColor: rgb(props.startConc),
    rightColor: rgb(props.endConc),
    content: divs(props.organellas, o => {
      o.produce = produceSubstance;
      return activeOrganella(o);
    })
  });
}

function cells(props) {
  return divs(props, activeCell);
}

// --- info

function showInfo(props) {
  const keys = Object.keys(props);
  return divs(keys, key => {
    let num = parseFloat(props[key]);
    const value = isNaN(num) ? props[key] : num;
    return div({padding: 5, border: '1px solid #888'}, key + ': ' + value);
  });
}

function info(props) {
  const { type, initConc, startConc, midConc, endConc, substances } = props;
  return div(
    { 'margin-top': 20 },
    showInfo({ type, initConc, startConc, midConc, endConc, title: 'substances' }) + showInfo(substances)
  );
}

// --- main

function render(props) {
  return cells(props.cells) + divs(state.cells, info);
}

function main() {
  requestAnimationFrame(main);
  document.body.innerHTML = render(state);
}
main();
</script>
</body>
</html>
