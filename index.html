<html>
<body>
<script>
function getCellDefaultState() {
  return {
    type: 'default',
    growingSpeed: 0.2,
    width: 20,
    height: 20,
    maxWidthBeforeDivide: 40,
    reducingSpeed: -0.5,
    organellas: [],
    divider: {color: 'red', width: 10, height: 10, top: 5, left: 5},
    initConc: 0.2,
    startConc: 1,
    get endConc() {
      return this.startConc - this.width / this.concLength;
    },
    concLength: 100
  };
}

function getDefaultState() {
  return {
    maxCells: 10,
    cells: [getCellDefaultState()]
  };
}

const state = getDefaultState();

// --- cell actions

function modWidth(props) {
  if (props.endConc >= 0) {
    props.width += props[props.type + 'Speed'];
  }
}

function divide(props) {
  if (state.cells.length < state.maxCells) {
    const newCell = getCellDefaultState();
    newCell.startConc = props.endConc;
    state.cells.push(newCell);
    props.width /= 2;
  }
}

function die(props) {
  const index = state.cells.indexOf(props);
  state.cells.splice(index, 1);
}

function cellAction(props) {
  let nextType;
  switch (props.type) {
    case 'default':
      props.organellas.push(props.divider);
      nextType = 'growing';
      break;
    case 'growing':
      modWidth(props);
      nextType = props.width >= props.maxWidthBeforeDivide ? 'division': props.type;
      break;
    case 'division':
      divide(props);
      nextType = 'growing';
      break;
    case 'reducing':
      modWidth(props);
      nextType = props.width <= 0 ? 'die' : props.type;
      break;
  }
  if (nextType === 'die') {
    die(props);
  } else {
    props.type = nextType;
  }
}

// --- utils

function style(o) {
  return Object.keys(o)
  .map(key => [key, o[key]].join(':'))
  .join(';');
}

function rgb(conc) {
  const color = Math.round((1 - conc) * 255);
  return 'rgb('+[color, color, color].join(',')+')';
}

function div(_style, content='') {
  return '<div style="'+style(_style)+'">'+content+'</div>';
}

// --- views

/**
 * props: {
    width: number;
    height: number;
    color: string;
    top: number;
    left: number;
  }
 */
function organella(props) {
  const { color, ...rest } = props;
  return div({
    position: 'absolute',
    background: color,
    ...rest
  });
}

/**
 * props: {
    width: string;
    height: string;
    startConc: number;
    endConc: number;
    showDivider: boolean;
  }
 */
function cell(props) {
  return div({
    display: 'inline-block',
    position: 'relative',
    border: '1px solid #444',
    background: 'linear-gradient(to right,'+rgb(props.startConc)+','+rgb(props.endConc)+')',
    ...props
  }, props.organellas.map(organella).join('') );
}

function activeCell(props) {
  cellAction(props);
  const { width, height, startConc, endConc } = props;
  return cell({
    width, height,
    startConc, endConc,
    organellas: props.organellas
  });
}

function cells(props) {
  return props.map(activeCell).join('');
}

function render(props) {
  return cells(props.cells);
}

function main() {
  requestAnimationFrame(main);
  document.body.innerHTML = render(state);
}
main();
</script>
</body>
</html>
